name: Gemini AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests

      - name: Run Gemini review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python - <<'PY'
          import os
          import sys
          import textwrap
          import subprocess
          import requests
          import google.generativeai as genai

          github_token = os.getenv("GITHUB_TOKEN")
          gemini_key = os.getenv("GEMINI_API_KEY")
          pr_number = os.getenv("PR_NUMBER")
          repo = os.getenv("REPO_FULL_NAME")
          base_ref = os.getenv("BASE_REF")

          if not github_token or not pr_number or not repo:
              print("Missing GitHub context; skipping Gemini review.")
              sys.exit(0)

          if not gemini_key:
              print("GEMINI_API_KEY not configured; skipping AI review.")
              sys.exit(0)

          try:
              diff_proc = subprocess.run(
                  ["git", "diff", f"origin/{base_ref}...HEAD"],
                  capture_output=True,
                  text=True,
                  check=True,
              )
              diff_text = diff_proc.stdout
          except subprocess.CalledProcessError as exc:
              print(f"Failed to fetch PR diff: {exc}")
              sys.exit(0)

          if not diff_text.strip():
              print("No diff content available; skipping Gemini review.")
              sys.exit(0)

          genai.configure(api_key=gemini_key)
          model = genai.GenerativeModel("gemini-1.5-pro")

          prompt = textwrap.dedent(
              """
              You are a senior security and performance reviewer. Analyze the following pull request diff for:
              - Security vulnerabilities (OWASP Top 10)
              - Performance bottlenecks
              - Code cleanliness (DRY, SOLID)
              - Logic errors

              Provide concise findings and actionable suggestions. If there are no issues, say the changes look good.
              """
          )

          try:
              response = model.generate_content(f"{prompt}\n\nDiff:\n{diff_text[:12000]}")
              review_comment = response.text.strip()
          except Exception as exc:
              print(f"Gemini review failed: {exc}")
              sys.exit(0)

          if not review_comment:
              print("Gemini returned no feedback; skipping comment.")
              sys.exit(0)

          api_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github+json',
          }
          payload = {
              'body': f"## ðŸ¤– Gemini AI Review\n\n{review_comment}"
          }

          try:
              post_resp = requests.post(api_url, headers=headers, json=payload, timeout=30)
              post_resp.raise_for_status()
              print("Review posted successfully")
          except Exception as exc:
              print(f"Failed to post Gemini review: {exc}")
              sys.exit(0)
          PY
        continue-on-error: true
