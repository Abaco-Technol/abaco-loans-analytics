name: Agent Performance Monitoring
on:
    schedule:
        - cron: "0 */6 * * *" # Every 6 hours
    workflow_dispatch:

env:
    OPIK_TOKEN: ${{ secrets.OPIK_TOKEN }}
    PHOENIX_TOKEN: ${{ secrets.PHOENIX_TOKEN }}
    FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}

jobs:
    monitor:
        if: ${{ secrets.OPIK_TOKEN != '' && secrets.PHOENIX_TOKEN != '' && secrets.FIGMA_TOKEN != '' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            - name: Query Opik for Agent Metrics
              if: ${{ hashFiles('scripts/query_opik_metrics.py') != '' }}
              run: |
                  python scripts/query_opik_metrics.py
            - name: Query Phoenix for Model Performance
              if: ${{ hashFiles('scripts/query_phoenix_performance.py') != '' }}
              run: |
                  python scripts/query_phoenix_performance.py
            - name: Calculate Agent Health Scores
              if: ${{ hashFiles('scripts/calculate_agent_health.py') != '' }}
              run: |
                  python scripts/calculate_agent_health.py
            - name: Detect Degradation
              if: ${{ hashFiles('scripts/detect_degradation.py') != '' }}
              run: |
                  python scripts/detect_degradation.py
            - name: Update Figma Agent Health Dashboard
              if: ${{ hashFiles('scripts/update_figma_agent_dashboard.py') != '' }}
              run: |
                  python scripts/update_figma_agent_dashboard.py
            - name: Post Summary to Slack #ops-alerts
              if: ${{ secrets.SLACK_BOT_TOKEN != '' && hashFiles('scripts/post_to_slack.py') != '' }}
              env:
                  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
              run: |
                  python scripts/post_to_slack.py --channel "#ops-alerts"
